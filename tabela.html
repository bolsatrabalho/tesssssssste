<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de FrequÃªncia de Bolsistas</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:20px;
}
.container{
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 4px 15px rgba(0,0,0,.1);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th{
  background:#f0f0f0;
}
input,select{
  width:100%;
  font-size:12px;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:5px;
  background:#0057b8;
  color:#fff;
  cursor:pointer;
}
button:hover{background:#004494}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">
<h2>Sistema de FrequÃªncia de Bolsistas</h2>

<div id="infoUsuario"></div>
<br>

<button id="btnAdd" onclick="adicionar()">âž• Adicionar Bolsista</button>
<button onclick="salvar()">ðŸ’¾ Salvar</button>
<button onclick="enviar()">ðŸ“¤ Enviar para Planilha</button>

<br><br>

<table>
<thead>
<tr>
  <th>Campus</th>
  <th>Nome</th>
  <th>MatrÃ­cula</th>
  <th>Setor</th>
  <th>InÃ­cio</th>
  <th>Fim</th>
  <th>Email Coordenador</th>
  <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>
  <th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>
  <th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
  <th>Justificativa</th>
  <th>Arquivo</th>
  <th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
// ================================
// CONFIG
// ================================
const URL_APPS = "https://script.google.com/macros/s/AKfycbx9hKI-sHbC8McpfSj_XkKZ5IKJyd8Yu2AUHnOChfkuRlRNfV0yWQJcXwXoAXHJfpV_FQ/exec";

const emailUsuario = sessionStorage.getItem("emailUsuario");
const tipoUsuario = sessionStorage.getItem("tipoUsuario"); // admin | coordenador

if(!emailUsuario || !tipoUsuario){
  alert("Acesso invÃ¡lido");
  location.href="index.html";
}

document.getElementById("infoUsuario").innerText =
  `UsuÃ¡rio: ${emailUsuario} | Perfil: ${tipoUsuario}`;

if(tipoUsuario !== "admin"){
  document.getElementById("btnAdd").classList.add("hidden");
}

// ================================
// DADOS
// ================================
let bolsistas = JSON.parse(localStorage.getItem("bolsistas")) || [];

// ================================
// RENDER
// ================================
function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  bolsistas.forEach((b,i)=>{
    if(tipoUsuario !== "admin" && b.coordenador !== emailUsuario) return;

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${campoTexto(b.campus,i,"campus",tipoUsuario==="admin")}</td>
      <td>${campoTexto(b.nome,i,"nome",tipoUsuario==="admin")}</td>
      <td>${campoTexto(b.matricula,i,"matricula",tipoUsuario==="admin")}</td>
      <td>${campoTexto(b.setor,i,"setor",tipoUsuario==="admin")}</td>
      <td>${campoData(b.inicio,i,"inicio",tipoUsuario==="admin")}</td>
      <td>${campoData(b.fim,i,"fim",tipoUsuario==="admin")}</td>
      <td>${campoTexto(b.coordenador,i,"coordenador",tipoUsuario==="admin")}</td>
      ${mesesHTML(b,i)}
      <td>${campoTexto(b.justificativa,i,"justificativa",true)}</td>
      <td><input type="file" onchange="upload(event,${i})"></td>
      <td>${tipoUsuario==="admin"?`<button onclick="remover(${i})">X</button>`:""}</td>
    `;
    tbody.appendChild(tr);
  });

  salvar();
}

// ================================
// CAMPOS
// ================================
function campoTexto(v,i,c,e){
  return e ? `<input value="${v||""}" onchange="atualizar(${i},'${c}',this.value)">` : (v||"");
}
function campoData(v,i,c,e){
  return e ? `<input type="date" value="${v||""}" onchange="atualizar(${i},'${c}',this.value)">` : (v||"");
}

function mesesHTML(b,i){
  const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  let html="";
  meses.forEach(m=>{
    const val = b[m] || "";
    html += `
      <td>
        <select onchange="atualizar(${i},'${m}',this.value)">
          <option value="" ${val===""?"selected":""}></option>
          <option value="SIM" ${val==="SIM"?"selected":""}>SIM</option>
          <option value="NÃƒO" ${val==="NÃƒO"?"selected":""}>NÃƒO</option>
        </select>
      </td>`;
  });
  return html;
}

// ================================
// AÃ‡Ã•ES
// ================================
function atualizar(i,c,v){ bolsistas[i][c]=v; salvar(); }

function adicionar(){
  bolsistas.push({
    campus:"", nome:"", matricula:"", setor:"",
    inicio:"", fim:"", coordenador:emailUsuario,
    justificativa:""
  });
  render();
}

function remover(i){
  if(confirm("Remover bolsista?")){
    bolsistas.splice(i,1);
    render();
  }
}

function salvar(){
  localStorage.setItem("bolsistas",JSON.stringify(bolsistas));
}

// ================================
// UPLOAD
// ================================
function upload(e,i){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ()=>{
    bolsistas[i].arquivoBase64 = reader.result.split(",")[1];
    bolsistas[i].arquivoNome = file.name;
    salvar();
  };
  reader.readAsDataURL(file);
}

// ================================
// ENVIO
// ================================
function enviar(){
  fetch(URL_APPS,{
    method:"POST",
    body: JSON.stringify(bolsistas)
  })
  .then(r=>r.json())
  .then(r=>{
    if(r.status==="ok") alert("Dados enviados com sucesso!");
    else alert("Erro: "+r.mensagem);
  })
  .catch(e=>alert("Erro de conexÃ£o"));
}

// ================================
render();
</script>
</body>
</html>
